<!--components/dialog/index.wxml-->
<view class="dialog-container {{visible ? 'visible' : 'hidden'}} {{peekMode ? 'peek-mode' : ''}}" animation="{{animationData}}" bindlongpress="handleLongPress" bindtouchend="handleTouchEnd">
  <!-- 导航栏 -->
  <view class="nav-bar-container" catchtap="handleClose">
    <nav-bar
      showBackButton="{{true}}"
      bind:back="handleClose"
    />
  </view>

  <!-- 毛玻璃效果背景 -->
  <view class="frosted-glass"></view>

  <!-- 对话区域 -->
  <scroll-view
    class="dialog-content"
    scroll-y="true"
    scroll-with-animation="true"
    scroll-anchoring="true"
    enhanced="true"
    bounces="true"
    show-scrollbar="false"
    enable-passive="true"
    id="dialogScroll"
    scroll-into-view="{{scrollToView}}"
    aria-busy="{{loading}}"
  >
    <!-- 加载提示 -->
    <view wx:if="{{loading && !messages.length}}" class="message loading">加载中...</view>

    <!-- 消息列表 -->
    <block wx:for="{{messages}}" wx:key="index">
      <!-- 用户消息 -->
      <view
        wx:if="{{item.role === 'user'}}"
        class="message user {{item.status ? item.status : ''}}"
        aria-label="用户消息: {{item.content}}"
        id="msg-{{index}}"
      >{{item.content}}</view>

      <!-- 系统和Agent回复消息 - 正常显示 -->
      <view
        wx:if="{{(item.role === 'system' || item.role === 'agent') && index !== animatingMessageIndex}}"
        class="message response {{item.status ? item.status : ''}}"
        aria-label="回复消息: {{item.content}}"
        id="msg-{{index}}"
      >> {{item.content}}</view>

      <!-- 系统和Agent回复消息 - 简化版打字机动画 -->
      <view
        wx:if="{{(item.role === 'system' || item.role === 'agent') && index === animatingMessageIndex}}"
        class="message response typing-simple {{item.status ? item.status : ''}}"
        aria-live="polite"
        id="msg-{{index}}"
      >> {{typingText}}</view>
    </block>

    <!-- 滚动锚点 -->
    <view id="scrollBottom" style="height: 10rpx;"></view>
  </scroll-view>

  <!-- 输入栏组件 -->
  <view class="input-bar-wrapper">
    <input-bar
      bind:send="handleSend"
      bind:voiceStart="handleVoiceStart"
      bind:voiceEnd="handleVoiceEnd"
      bind:voiceCancel="handleVoiceCancel"
    />
  </view>
</view>
