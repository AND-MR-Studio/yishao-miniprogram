<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/theme-chalk/index.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
        }
        .header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .pagination {
            margin-top: 20px;
            text-align: right;
        }
        .tag {
            margin-right: 5px;
        }
        .level-info {
            display: flex;
            align-items: center;
        }
        .level-progress {
            margin-left: 10px;
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h2>用户管理系统</h2>
                <div>
                    <el-button type="info" @click="openApiDocs">API文档</el-button>
                    <el-button type="primary" @click="refreshData">刷新数据</el-button>
                </div>
            </div>

            <!-- 搜索框 -->
            <div class="search-box">
                <el-input
                    v-model="searchQuery"
                    placeholder="搜索用户昵称/用户ID"
                    clearable
                    @clear="handleSearch"
                    style="width: 300px;">
                </el-input>
                <el-button type="primary" @click="handleSearch">搜索</el-button>
            </div>

            <!-- 用户列表 -->
            <el-table
                :data="filteredUsers"
                border
                style="width: 100%"
                v-loading="loading">
                <el-table-column
                    prop="nickName"
                    label="昵称"
                    width="150">
                </el-table-column>
                <el-table-column
                    prop="userId"
                    label="用户ID"
                    width="200">
                </el-table-column>
                <el-table-column
                    prop="createTime"
                    label="注册时间"
                    width="150">
                    <template slot-scope="scope">
                        {{ formatDate(scope.row.createTime) }}
                    </template>
                </el-table-column>
                <el-table-column
                    label="等级信息"
                    width="200">
                    <template slot-scope="scope">
                        <div class="level-info">
                            <el-tag type="success">Lv.{{ scope.row.level || 1 }}</el-tag>
                            <span style="margin-left: 5px;">{{ scope.row.levelTitle || '初级侦探' }}</span>
                        </div>
                        <el-progress
                            class="level-progress"
                            :percentage="calculateLevelProgress(scope.row)"
                            :format="format => `${scope.row.experience || 0}/${scope.row.maxExperience || 1000}`"
                            :stroke-width="10">
                        </el-progress>
                    </template>
                </el-table-column>
                <!-- 修改表格列，移除签到按钮和签到状态显示 -->
                <el-table-column
                    label="积分信息"
                    width="150">
                    <template slot-scope="scope">
                        <div>积分: {{ scope.row.points || 0 }}</div>
                        <div>签到: {{ scope.row.signInCount || 0 }}次</div>
                    </template>
                </el-table-column>
                <el-table-column
                    label="答题统计"
                    width="180">
                    <template slot-scope="scope">
                        <div>总答题: {{ scope.row.totalAnswered || 0 }}</div>
                        <div>正确率: {{ calculateAccuracy(scope.row) }}%</div>
                        <div>浏览量: {{ scope.row.totalViewed || 0 }}</div>
                        <div>今日剩余: {{ scope.row.remainingAnswers || 0 }}次</div>
                    </template>
                </el-table-column>
                <el-table-column
                    label="内容统计"
                    width="150">
                    <template slot-scope="scope">
                        <div>未解: {{ scope.row.unsolvedCount || 0 }}</div>
                        <div>已解: {{ scope.row.solvedCount || 0 }}</div>
                        <div>创作: {{ scope.row.creationCount || 0 }}</div>
                        <div>收藏: {{ scope.row.favoriteCount || 0 }}</div>
                    </template>
                </el-table-column>
                <el-table-column
                    label="操作"
                    width="200">
                    <template slot-scope="scope">
                        <el-button
                            size="mini"
                            @click="handleEdit(scope.row)">编辑</el-button>
                        <el-button
                            size="mini"
                            type="danger"
                            @click="handleDelete(scope.row)">删除</el-button>
                    </template>
                </el-table-column>
            </el-table>

            <!-- 分页 -->
            <div class="pagination">
                <el-pagination
                    @size-change="handleSizeChange"
                    @current-change="handleCurrentChange"
                    :current-page="currentPage"
                    :page-sizes="[10, 20, 50, 100]"
                    :page-size="pageSize"
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="total">
                </el-pagination>
            </div>

            <!-- 编辑用户对话框 -->
            <el-dialog title="编辑用户" :visible.sync="dialogVisible" width="500px">
                <el-form :model="editForm" label-width="100px">
                    <el-form-item label="昵称">
                        <el-input v-model="editForm.nickName"></el-input>
                    </el-form-item>
                    <el-form-item label="头像">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <img :src="editForm.avatarUrl || '/uploads/avatars/default-avatar.jpg'"
                                 style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-right: 15px;">
                        </div>
                        <el-input v-model="editForm.avatarUrl" placeholder="头像URL"></el-input>
                        <div style="margin-top: 5px; color: #909399; font-size: 12px;">
                            输入头像图片的URL地址，用户头像上传应在小程序端进行
                        </div>
                    </el-form-item>
                    <el-form-item label="等级">
                        <el-input-number v-model="editForm.level" :min="1" :max="100"></el-input-number>
                    </el-form-item>
                    <el-form-item label="经验值">
                        <el-input-number v-model="editForm.experience" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="经验上限">
                        <el-input-number v-model="editForm.maxExperience" :min="1000" :step="200"></el-input-number>
                    </el-form-item>
                    <el-form-item label="积分">
                        <el-input-number v-model="editForm.points" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="签到次数">
                        <el-input-number v-model="editForm.signInCount" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="剩余答题次数">
                        <el-input-number v-model="editForm.remainingAnswers" :min="0" :max="999"></el-input-number>
                    </el-form-item>

                    <el-divider content-position="center">统计数据</el-divider>

                    <el-form-item label="总答题数">
                        <el-input-number v-model="editForm.totalAnswered" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="正确答题数">
                        <el-input-number v-model="editForm.totalCorrect" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="总浏览数">
                        <el-input-number v-model="editForm.totalViewed" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="已解决数">
                        <el-input-number v-model="editForm.solvedCount" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="未解决数">
                        <el-input-number v-model="editForm.unsolvedCount" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="创作数">
                        <el-input-number v-model="editForm.creationCount" :min="0"></el-input-number>
                    </el-form-item>
                    <el-form-item label="收藏数">
                        <el-input-number v-model="editForm.favoriteCount" :min="0"></el-input-number>
                    </el-form-item>
                </el-form>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="dialogVisible = false">取 消</el-button>
                    <el-button type="primary" @click="handleSave">确 定</el-button>
                </span>
            </el-dialog>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/index.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                users: [],
                searchQuery: '',
                loading: false,
                currentPage: 1,
                pageSize: 10,
                total: 0,
                dialogVisible: false,
                today: new Date().toISOString().split('T')[0],
                editForm: {
                    userId: '',
                    nickName: '',
                    avatarUrl: '',
                    level: 1,
                    experience: 0,
                    maxExperience: 1000,
                    points: 0,
                    signInCount: 0,
                    remainingAnswers: 100,
                    totalAnswered: 0,
                    totalCorrect: 0,
                    totalViewed: 0,
                    solvedCount: 0,
                    unsolvedCount: 0,
                    creationCount: 0,
                    favoriteCount: 0
                }
            },
            computed: {
                filteredUsers() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    let result = this.users;

                    if (this.searchQuery) {
                        result = result.filter(user =>
                            user.nickName?.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                            user.userId?.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );
                    }

                    this.total = result.length;
                    return result.slice(start, end);
                }
            },
            methods: {
                // 修改请求方法，移除token验证
                async request(url, method = 'GET', data = null) {
                    try {
                        const response = await axios({
                            url,
                            method,
                            data
                        });

                        return response.data;
                    } catch (error) {
                        console.error('请求失败:', error);
                        throw error;
                    }
                },

                // 修改获取用户列表方法
                async fetchUsers() {
                    this.loading = true;
                    try {
                        const response = await this.request('/yishao-api/user/list');
                        if (response.success) {
                            this.users = response.data;
                        } else {
                            this.$message.error(response.error || '获取用户列表失败');
                        }
                    } catch (error) {
                        this.$message.error('获取用户列表失败：' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },

                // 修改保存用户信息方法 - 使用管理员接口

                formatDate(date) {
                    if (!date) return '';
                    return new Date(date).toLocaleString('zh-CN');
                },
                calculateAccuracy(user) {
                    if (!user.totalAnswered) return 0;
                    return Math.round((user.totalCorrect || 0) / user.totalAnswered * 100);
                },
                calculateLevelProgress(user) {
                    const exp = user.experience || 0;
                    const maxExp = user.maxExperience || 1000;
                    return Math.min(Math.round(exp / maxExp * 100), 100);
                },
                handleSearch() {
                    this.currentPage = 1;
                },
                handleSizeChange(size) {
                    this.pageSize = size;
                    this.currentPage = 1;
                },
                handleCurrentChange(page) {
                    this.currentPage = page;
                },
                handleEdit(row) {
                    this.editForm = {
                        userId: row.userId,
                        nickName: row.nickName,
                        avatarUrl: row.avatarUrl,
                        level: row.level || 1,
                        experience: row.experience || 0,
                        maxExperience: row.maxExperience || 1000,
                        points: row.points || 0,
                        signInCount: row.signInCount || 0,
                        remainingAnswers: row.remainingAnswers || 100,
                        totalAnswered: row.totalAnswered || 0,
                        totalCorrect: row.totalCorrect || 0,
                        totalViewed: row.totalViewed || 0,
                        solvedCount: row.solvedCount || 0,
                        unsolvedCount: row.unsolvedCount || 0,
                        creationCount: row.creationCount || 0,
                        favoriteCount: row.favoriteCount || 0
                    };
                    this.dialogVisible = true;
                },
                async handleSave() {
                    try {
                        const response = await this.request('/yishao-api/user/admin-update', 'POST', this.editForm);
                        if (response.success) {
                            this.$message.success('更新成功');
                            this.dialogVisible = false;
                            this.fetchUsers();
                        } else {
                            this.$message.error(response.error || '更新失败');
                        }
                    } catch (error) {
                        this.$message.error('更新失败：' + error.message);
                    }
                },


                async handleDelete(row) {
                    try {
                        // 使用await等待确认对话框的结果
                        await this.$confirm('确定要删除该用户吗？', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });

                        // 如果用户点击了确定，代码会继续执行到这里
                        // 如果用户点击了取消，会抛出异常并被catch捕获
                        const response = await this.request('/yishao-api/user/delete', 'POST', {
                            userId: row.userId
                        });

                        if (response.success) {
                            this.$message.success('删除成功');
                            this.fetchUsers();
                        } else {
                            this.$message.error(response.error || '删除失败');
                        }
                    } catch (error) {
                        // 如果是用户取消操作，显示取消信息
                        if (error === 'cancel') {
                            this.$message.info('已取消删除');
                        } else {
                            // 其他错误
                            this.$message.error('删除失败：' + error.message);
                        }
                    }
                },

                refreshData() {
                    this.fetchUsers();
                },
                openApiDocs() {
                    window.open('/docs', '_blank');
                }
            },
            mounted() {
                // 直接获取用户列表，移除token检查
                this.fetchUsers();
            }
        });
    </script>
</body>
</html>