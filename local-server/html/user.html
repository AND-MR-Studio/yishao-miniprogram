<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/theme-chalk/index.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
        }
        .header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .pagination {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h2>用户管理系统</h2>
                <el-button type="primary" @click="refreshData">刷新数据</el-button>
            </div>

            <!-- 搜索框 -->
            <div class="search-box">
                <el-input
                    v-model="searchQuery"
                    placeholder="搜索用户昵称/OpenID"
                    clearable
                    @clear="handleSearch"
                    style="width: 300px;">
                </el-input>
                <el-button type="primary" @click="handleSearch">搜索</el-button>
            </div>

            <!-- 用户列表 -->
            <el-table
                :data="filteredUsers"
                border
                style="width: 100%"
                v-loading="loading">
                <el-table-column
                    prop="nickName"
                    label="昵称"
                    width="150">
                </el-table-column>
                <el-table-column
                    prop="openid"
                    label="OpenID"
                    width="280">
                </el-table-column>
                <el-table-column
                    prop="createTime"
                    label="注册时间"
                    width="180">
                    <template slot-scope="scope">
                        {{ formatDate(scope.row.createTime) }}
                    </template>
                </el-table-column>
                <el-table-column
                    label="统计数据"
                    width="280">
                    <template slot-scope="scope">
                        <div>总答题: {{ scope.row.totalAnswered || 0 }}</div>
                        <div>正确率: {{ calculateAccuracy(scope.row) }}%</div>
                        <div>浏览量: {{ scope.row.totalViewed || 0 }}</div>
                    </template>
                </el-table-column>
                <el-table-column
                    label="操作"
                    width="200">
                    <template slot-scope="scope">
                        <el-button
                            size="mini"
                            @click="handleEdit(scope.row)">编辑</el-button>
                        <el-button
                            size="mini"
                            type="danger"
                            @click="handleDelete(scope.row)">删除</el-button>
                    </template>
                </el-table-column>
            </el-table>

            <!-- 分页 -->
            <div class="pagination">
                <el-pagination
                    @size-change="handleSizeChange"
                    @current-change="handleCurrentChange"
                    :current-page="currentPage"
                    :page-sizes="[10, 20, 50, 100]"
                    :page-size="pageSize"
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="total">
                </el-pagination>
            </div>

            <!-- 编辑用户对话框 -->
            <el-dialog title="编辑用户" :visible.sync="dialogVisible" width="500px">
                <el-form :model="editForm" label-width="100px">
                    <el-form-item label="昵称">
                        <el-input v-model="editForm.nickName"></el-input>
                    </el-form-item>
                    <el-form-item label="头像">
                        <el-input v-model="editForm.avatarUrl"></el-input>
                    </el-form-item>
                </el-form>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="dialogVisible = false">取 消</el-button>
                    <el-button type="primary" @click="handleSave">确 定</el-button>
                </span>
            </el-dialog>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/index.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                users: [],
                searchQuery: '',
                loading: false,
                currentPage: 1,
                pageSize: 10,
                total: 0,
                dialogVisible: false,
                editForm: {
                    openid: '',
                    nickName: '',
                    avatarUrl: ''
                }
            },
            computed: {
                filteredUsers() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    let result = this.users;
                    
                    if (this.searchQuery) {
                        result = result.filter(user => 
                            user.nickName?.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                            user.openid?.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );
                    }
                    
                    this.total = result.length;
                    return result.slice(start, end);
                }
            },
            methods: {
                async fetchUsers() {
                    this.loading = true;
                    try {
                        const response = await axios.get('/api/user/list');
                        if (response.data.success) {
                            this.users = response.data.data;
                        } else {
                            this.$message.error(response.data.error || '获取用户列表失败');
                        }
                    } catch (error) {
                        this.$message.error('获取用户列表失败：' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                formatDate(date) {
                    if (!date) return '';
                    return new Date(date).toLocaleString('zh-CN');
                },
                calculateAccuracy(user) {
                    if (!user.totalAnswered) return 0;
                    return Math.round((user.totalCorrect || 0) / user.totalAnswered * 100);
                },
                handleSearch() {
                    this.currentPage = 1;
                },
                handleSizeChange(val) {
                    this.pageSize = val;
                    this.currentPage = 1;
                },
                handleCurrentChange(val) {
                    this.currentPage = val;
                },
                handleEdit(row) {
                    this.editForm = { ...row };
                    this.dialogVisible = true;
                },
                async handleSave() {
                    try {
                        const response = await axios.post('/api/user/update', this.editForm);
                        if (response.data.success) {
                            this.$message.success('保存成功');
                            this.dialogVisible = false;
                            await this.fetchUsers();
                        } else {
                            this.$message.error(response.data.error || '保存失败');
                        }
                    } catch (error) {
                        this.$message.error('保存失败：' + error.message);
                    }
                },
                async handleDelete(row) {
                    try {
                        await this.$confirm('确认删除该用户吗？此操作不可恢复', '提示', {
                            type: 'warning'
                        });
                        
                        const response = await axios.post('/api/user/delete', {
                            openid: row.openid
                        });
                        
                        if (response.data.success) {
                            this.$message.success('删除成功');
                            await this.fetchUsers();
                        } else {
                            this.$message.error(response.data.error || '删除失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('删除失败：' + error.message);
                        }
                    }
                },
                refreshData() {
                    this.fetchUsers();
                }
            },
            mounted() {
                this.fetchUsers();
            }
        });
    </script>
</body>
</html> 